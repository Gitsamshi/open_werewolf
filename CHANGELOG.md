# 更新日志

## [1.5.0] - 2025-10-25

### ✨ 新功能

#### 1. 狼人互认身份与战术系统
添加狼人互相认识和夜间战术讨论的完整说明：

**游戏基本规则新增**：
- **狼人互相认识**：游戏开始时，所有狼人都知道其他狼人是谁
- 狼人之间是队友关系，要互相配合
- 可以制定各种高级战术

**狼人战术策略**（在"身份伪装与角色扮演策略"中新增）：
- **狼自刀骗解药**：让狼队友刀自己，骗女巫用解药，建立"银水"身份（高风险高回报）
- **狼查杀狼**：悍跳预言家后，"查杀"狼队友，牺牲一狼换取预言家可信度
- **狼打狼**：白天互相怀疑、对抗，迷惑好人
- **深水狼策略**：一狼悍跳吸引火力，另一狼潜伏装好人
- **集火神职**：优先刀掉预言家、女巫等强神

**狼人配合指导**：
- 可以"怀疑"狼队友来增加自己可信度（狼打狼战术）
- 也可以互相"金水"建立信任关系
- 根据战术需要灵活调整
- 不要在白天暴露你们是队友关系

#### 2. 明确狼自刀的规则
- 狼人可以刀狼队友（狼自刀）来骗女巫解药
- 狼自刀也算"杀人"，符合"狼人每晚必须杀人"的规则

### 📝 更新的文件
- `src/players/player.py` - AI系统提示词

### 🎯 预期效果
- AI狼人会理解他们之间是队友关系
- AI狼人会使用高级战术（狼自刀、狼查杀狼等）
- 提升狼人阵营的策略深度和游戏趣味性
- 游戏对抗更加激烈和真实

## [1.4.3] - 2025-10-25

### 🐛 Bug修复
- **修复AI可能说出"狼人空刀"的错误发言**：强化"狼人不能空刀"的规则说明
  - 问题：AI在遇到平安夜时可能会说"狼人可能空刀了"、"狼人怕被查杀所以空刀"等违反规则的话
  - 原因：狼人每晚必须杀人，不能空刀，平安夜只能是女巫救人
  - 修复：在游戏基本规则和信息保密规则中明确禁止这种说法

### 📝 规则强化内容
1. **游戏基本规则第1条扩充**：
   - ❌ 发言时绝对不要说"狼人可能空刀了"、"狼人怕被查杀所以空刀"等违反规则的话
   - ✅ 平安夜的原因只有一个：女巫用了解药救人
   - ✅ 如果昨晚是平安夜，正确的分析是："昨晚平安夜，说明女巫救人了"

2. **信息保密规则（狼人部分）扩充**：
   - ❌ 绝对不要说"狼人可能空刀了"（违反规则，会暴露你不懂游戏）
   - ✅ 遇到平安夜时，可以说："不知道发生了什么，可能女巫救人了"
   - ✅ 或者含糊其辞："昨晚信息量不大"

### 📝 更新的文件
- `src/players/player.py` - AI系统提示词

## [1.4.2] - 2025-10-25

### ✨ 新功能
- **添加"民及民以上身份"话术说明**：在游戏常用语中添加这个常用术语
  - 含义：指村民或神职（预言家、女巫、猎人），即好人阵营的身份
  - 用法：常用于表达"我是好人"（例如："我是民及民以上身份"）
  - 帮助AI使用更专业的狼人杀术语

### 📝 规则说明强化
- **明确猎人开枪规则**：在游戏基本规则中更详细地说明猎人开枪条件
  - ✅ 猎人被狼刀死亡时，可以开枪
  - ✅ 猎人被投票放逐死亡时，可以开枪
  - ❌ 猎人被女巫毒死时，**不能开枪**（重要规则）
  - 代码层面已实现（在 `_process_night_deaths()` 中会调用 `hunter_role.disable_shoot()`）

### 📝 更新的文件
- `src/players/player.py` - AI系统提示词

## [1.4.1] - 2025-10-25

### 🐛 Bug修复
- **修复猎人开枪后未检查游戏结束条件**: 猎人开枪带走玩家后，游戏应立即检查是否满足结束条件
  - 问题场景：猎人带走最后一个神职后，游戏应该结束，但却继续进入夜晚
  - 修复：在 `_last_words()` 中猎人开枪后立即调用 `_check_game_over()`
  - 修复：在 `_day_phase()` 遗言环节后也检查游戏是否结束
  - 现在猎人开枪带走关键玩家后，游戏会立即结束

### 📝 更新的文件
- `src/game/werewolf_game.py` - 遗言环节和白天阶段逻辑

### 🔧 修复细节
- 在 `_last_words()` 方法中，猎人开枪后添加游戏结束检查
- 在 `_day_phase()` 方法中，遗言环节后添加游戏结束检查
- 如果游戏已结束，立即返回，不再继续后续流程

## [1.4.0] - 2025-10-25

### ✨ 新功能

#### 1. 发言顺序优化
玩家死亡后，第二天从死者右边（+1位置）的玩家开始发言：
- 符合标准狼人杀规则
- 自动调整发言顺序，从死者右边开始循环
- 系统会显示提示："（从玩家X的右边开始发言）"
- 如果昨晚是平安夜（无人死亡），保持原有顺序

#### 2. 游戏基本规则说明
在AI系统提示词中添加"游戏基本规则"部分：
- **狼人每晚必须杀人**（不能空刀）
- **女巫不能自救**
- **女巫每晚只能用一瓶药**
- **猎人被毒死不能开枪**
- **发言顺序规则**

这些是狼人杀的基本游戏常识，让AI更好地理解游戏规则。

### 📝 更新的文件
- `src/game/werewolf_game.py` - 发言阶段逻辑
- `src/players/player.py` - AI系统提示词，添加游戏基本规则

### 🔧 实现细节
- 添加 `last_night_first_death` 变量追踪昨晚第一个死亡的玩家
- 在 `_process_night_deaths()` 中记录死亡玩家
- 在 `_speech_phase()` 中根据死者位置重新排序发言顺序
- 使用循环索引确保从死者+1位置开始遍历所有存活玩家
- 在狼人角色介绍中强调"必须"杀人（不能空刀）
- 添加独立的"游戏基本规则"章节列出5条核心规则

## [1.3.0] - 2025-10-25

### ✨ 新功能

#### 1. 增强AI发言分析能力
添加"发言分析与防骗指南"：
- 教导AI不要完全相信任何玩家的发言
- 提供5个维度的发言分析方法：
  1. 验证逻辑一致性
  2. 分析发言动机
  3. 观察行为模式
  4. 交叉验证信息
  5. 保持怀疑态度
- 强调狼人可以假冒任何好身份
- 提醒AI要用逻辑分析，不要盲目相信

#### 2. 身份伪装与角色扮演策略
添加"身份伪装与角色扮演策略"指南：
- **核心提示**：发言前先想"我应该表演成什么身份？"
- **狼人策略**：
  - 选择伪装身份（悍跳预言家、假跳神职、装村民、暗示有身份）
  - 保持人设一致性
  - 混入好人阵营的技巧
- **村民策略**：
  - 战术性伪装（暗示有身份吸引狼刀）
  - 风险平衡（伪装 vs 坦白）
- **各神职策略**：
  - 预言家：早跳/晚跳/对跳的时机选择
  - 女巫：隐藏身份，关键时刻跳女巫
  - 猎人：深藏不露，被推时跳猎人

### 📝 更新的文件
- `src/players/player.py` - AI系统提示词

### 🎯 预期效果
- AI玩家会更加谨慎地分析他人发言
- AI会主动思考应该扮演什么身份
- 狼人AI会有更多样化的伪装策略
- 村民AI会考虑战术性伪装
- 神职AI会选择更合适的跳神时机
- 减少AI被悍跳狼人欺骗的可能性
- 提升游戏的策略性和对抗性
- 使AI的推理过程更接近真实玩家

## [1.2.1] - 2025-10-25

### 🐛 Bug修复
- **修复狼人未做出有效选择的bug**: 狼人每晚必须击杀一名玩家
  - 原因：AI响应格式不正确时，`_parse_player_id`返回None，狼人不杀人
  - 修复：添加重试机制（最多3次），如果仍然失败则随机选择目标
  - 添加明确提示："⚠️ 重要：狼人每晚必须击杀一名玩家"
  - 现在狼人一定会击杀一名玩家，保证游戏流程正常

### 📝 更新的文件
- `src/game/werewolf_game.py` - 狼人行动逻辑

### ⚠️ 重要变更
- **狼人击杀保证机制**: 如果AI无法做出有效选择，系统会随机选择目标
  - 优点：保证游戏规则完整性
  - 缺点：极端情况下可能出现随机选择（但会有明确提示）

## [1.2.0] - 2025-10-25

### 🐛 Bug修复
- **修复预言家查验结果错误**: 玩家名称与实际角色不匹配导致查验结果错误
  - 原因：角色随机分配导致"AI-狼人1"可能不是狼人
  - 修复：改为固定角色分配，确保名称与角色一致
  - 现在玩家1-3永远是狼人，玩家4是预言家，依此类推

- **修复女巫可以自救的bug**: 女巫不应该能救自己
  - 原因：条件判断逻辑错误 (`not is_self or not witch_role.cannot_save_self`)
  - 修复：正确的逻辑 (`is_self and witch_role.cannot_save_self`)
  - 现在女巫被击杀时会显示"女巫被击杀，但不能自救"

- **修复女巫同一晚使用两瓶药的bug**: 女巫每晚最多只能使用一瓶药
  - 原因：没有检查是否已使用解药就继续询问毒药
  - 修复：添加 `used_potion_tonight` 标记，使用解药后不再询问毒药
  - 现在女巫使用解药后会显示"女巫今晚已使用解药，不能再使用毒药"

- **修复女巫解药不生效的bug**: 女巫使用解药后玩家仍然死亡
  - 原因：函数内部修改`wolf_kill_target = None`不影响外部变量
  - 修复：修改函数返回值，返回修改后的`wolf_kill_target`和`poison_target`
  - 现在女巫使用解药后，被救的玩家会正确存活

- **修复女巫记忆保存bug**: 救人后记忆保存的玩家ID错误
  - 原因：`wolf_kill_target`被设为None后再保存记忆
  - 修复：先保存被救玩家信息，再清空`wolf_kill_target`

### 📝 更新的文件
- `src/game/werewolf_game.py` - 角色分配逻辑、女巫行动逻辑
- 新增 `BUGFIX_v1.2.0.md` - 详细的bug修复说明

### ⚠️ 重要变更
- **角色分配不再随机**: 为确保玩家名称与角色一致，角色位置固定
  - 优点：便于调试和观察
  - 缺点：缺少随机性
  - 建议：后续可添加配置选项支持随机模式

## [1.1.1] - 2025-10-25

### ✨ 改进
- **更新AI系统提示词**: 使用专业狼人杀术语和规则
  - 添加完整的游戏规则体系
  - 添加10个专业术语（查杀、金水、银水、悍跳等）
  - 增强策略指导
  - 修正女巫规则描述（明确不能自救）

### 📝 更新的文件
- `src/players/player.py` - AI玩家系统提示词
- 新增 `SYSTEM_PROMPT_UPDATE.md` - 系统提示词更新说明

## [1.1.0] - 2025-10-25

### 修复
- **移除不可用的模型**: 移除了在当前AWS区域不可用的模型
  - 移除 `us.deepseek.v3-v1:0` (ValidationException)
  - 移除 `us.deepseek.r1-v1:0` (ValidationException)
  - 移除 `us.anthropic.claude-3-5-sonnet-20241022-v2:0` (已被新版本替代)

### 变更
- **更新AI模型分配**: 所有角色现在仅使用可用的Claude系列模型
  - 狼人1: Claude Opus 4 (20250514)
  - 狼人2: Claude Sonnet 4.5 (20250929)
  - 狼人3: Claude 3.7 Sonnet (20250219)
  - 预言家: Claude Opus 4.1 (20250805)
  - 女巫: Claude Sonnet 4 (20250514)
  - 猎人: Claude Sonnet 4.5 (20250929) ← 更新
  - 村民1: Claude Haiku 4.5 (20251001) ← 更新
  - 村民2: Claude 3.7 Sonnet (20250219) ← 更新
  - 村民3: Claude Haiku 4.5 (20251001)

### 更新的文件
- `src/utils/llm_client.py` - 更新可用模型列表和默认分配
- `config_example.py` - 更新配置示例
- `test_setup.py` - 更新测试模型列表
- `README.md` - 更新模型分配表格
- 新增 `CHANGELOG.md` - 记录版本变更

### 影响
- ✅ 游戏现在只使用经过验证的可用模型
- ✅ 不再出现模型调用错误
- ✅ 所有AI玩家都能正常工作
- ℹ️ 性能可能略有提升（全部使用Claude系列高质量模型）
- ⚠️ 成本可能略有增加（Haiku替代了DeepSeek）

## [1.0.0] - 2025-10-25

### 新增
- 🎮 完整的9人狼人杀游戏实现
- 🤖 支持9种不同AI模型
- 👥 支持人类和AI混合对战
- 📚 完整的游戏文档
- 🔧 环境测试工具
- 🚀 快速启动脚本

### 角色实现
- 狼人（3名）- 夜晚击杀
- 预言家 - 查验身份
- 女巫 - 解药和毒药
- 猎人 - 死亡开枪
- 村民（3名）- 投票推理

### 游戏特性
- 完整的夜晚/白天循环
- 遗言系统
- 投票放逐
- 胜负判定
- AI记忆系统
