# 更新日志

## [1.6.1] - 2025-10-26

### ✨ 新功能 - 分角色高级玩法策略

#### 实现角色专属prompt系统
为了提升AI玩家的策略深度并保持prompt精简,实现了**分角色prompt**系统,每个角色只看到与自己相关的高级策略指导。

**新增内容**：

**1. 预言家高级策略**：
- 警徽流策略：理解警徽流的核心思想和使用方法
- 对抗悍跳狼：如何压制悍跳狼并建立可信度
- 发言技巧：积极公布身份,留好警徽流
- 查验策略：首晚查验建议,查验优先级

**2. 女巫高级策略**：
- 解药使用策略：首夜开解药的概率分析(63% vs 36%)
- 毒药使用策略：谨慎使用,确定目标时毒
- 起跳时机：解药用完、毒药在手时起跳带队
- 保密策略：不暴露刀口,不泄露用药信息

**3. 猎人高级策略**：
- 身份策略：通过开枪自证,狼人一般不对跳
- 开枪技巧：最高明的枪法是枪杀深水狼,早期可保守吞枪
- 发言技巧：混乱时明跳身份,强势站队真预言家
- 生存策略：替神挡刀,关键时刻跳猎人自保

**4. 狼人高级策略(悍跳预言家)**：
- 悍跳技巧：催眠自己成真预言家,保持正义感
- 验人信息策略：给警下好人发金水,前置位发金水
- 状态掌控：展现预言家视角,不清楚死亡情况
- 团队配合：首夜准备,狼打狼战术,冲票配合
- 警徽流技巧：模仿真预言家,设计合理的警徽流

**5. 村民高级策略**：
- 表水技巧：站边表态、点评发言、讲清心路历程
- 生存策略：不断做好事,辅助好人找狼,不要划水
- 战术性伪装：暗示有身份吸引狼刀,保护真神
- 辅助神职：站队真预言家,保护神职,推理找狼

### 🏗️ 技术实现

**代码结构**：
- 新增 `_get_role_advanced_strategy()` 方法
- 根据 `role_type` 返回对应角色的高级策略prompt
- 在 `_build_system_prompt()` 中动态追加角色策略

**优势**：
- ✅ **prompt精简**：每个角色只看到自己相关的策略,避免信息过载
- ✅ **策略针对性**：专门的指导让AI更专业地扮演该角色
- ✅ **易于维护**：角色策略独立,修改某个角色不影响其他
- ✅ **可扩展性**：未来添加新角色或新策略非常方便

### 📝 更新的文件
- `src/players/player.py` - 新增 `_get_role_advanced_strategy()` 方法,实现分角色prompt系统

### 🎯 预期效果
- ✅ 预言家AI会使用警徽流策略,对抗悍跳更有力
- ✅ 女巫AI会首夜开解药,毒药使用更谨慎
- ✅ 猎人AI会保守吞枪或精准枪杀深水狼
- ✅ 狼人AI悍跳预言家更专业,警徽流更合理
- ✅ 村民AI表水更清晰,站队更坚定
- ✅ 整体游戏策略深度大幅提升

### 📊 代码统计
- 新增代码：~180行(5个角色的高级策略)
- 新增方法：1个 (`_get_role_advanced_strategy`)
- 修改现有方法：1个 (`_build_system_prompt`)

## [1.6.0] - 2025-10-26

### ✨ 新功能 - 警长系统（重大更新）

#### 完整的警长（警徽）机制
添加了完整的警长系统，这是狼人杀游戏的核心玩法之一。

**1. 警长竞选（上警）流程**：
- **首日白天**：在遗言环节后、发言环节前进行警长竞选
- **四个阶段**：
  1. **报名阶段**：所有玩家选择是否参与竞选（上警）
  2. **竞选发言**：上警玩家依次发表竞选发言（100-150字）
  3. **退水阶段**：发言结束后，候选人可以选择退出竞选（退水）
  4. **投票选举**：未上警（警下）玩家投票选出警长
- **⚠️ 重要规则**：只有警下玩家才能投票！
- **特殊情况**：
  - 无人上警：本局无警长
  - 一人上警：自动当选
  - 所有人上警：**警徽流失**（无警下玩家投票，本局无警长）
  - 所有候选人退水：**警徽流失**（本局无警长）
  - 退水后剩一人：自动当选
  - 投票平票：随机选出

**2. 警长三大权利**：
- **1.5倍投票权**：
  - 警长的一票计为1.5票
  - 投票统计时会显示："3.5票 (包含警长1.5票)"
  - 可以在平票时打破僵局

- **归票权（最后发言权）**：
  - 每轮发言阶段，警长最后发言
  - 系统提示："警长玩家X拥有归票权，将最后发言"
  - 可以总结分析，引导投票方向

- **警徽传递权**：
  - 警长死亡时，遗言后可以传递警徽
  - 可以传给任何存活玩家
  - 也可以选择撕毁警徽（不传）
  - 系统提示：🎖️ 警徽传递给玩家X！

**3. 退水机制**：
- **退水时机**：竞选发言结束后、投票之前
- **退水原因**：
  - 狼人听到真预言家跳了，战术性退水
  - 好人觉得其他候选人更合适
  - 神职不想过度暴露身份
- **退水影响**：可能让人怀疑，但也可能是战术选择
- **退水后果**：
  - 所有候选人退水 → 警徽流失
  - 退水后剩一人 → 自动当选

**4. AI策略指导**：
- 上警策略：神职/村民/狼人的不同考量
- 竞选发言要点：展示能力、暗示身份、获取信任
- 退水策略：何时该退、如何解释退水行为
- 警徽传递策略：好人传给可信玩家，狼人传给队友

**5. 游戏流程变化**：
```
第1天：夜晚 → 宣布死亡 → 遗言 → 【警长竞选（报名→发言→退水→投票）】 → 发言（警长最后） → 投票（警长1.5票）
第2天+：夜晚 → 宣布死亡 → 遗言【警长传递】 → 发言（警长最后） → 投票（警长1.5票）
```

### 📝 更新的文件
- `src/game/werewolf_game.py` - 警长系统核心逻辑
  - 添加状态管理：`sheriff`、`sheriff_election_done`
  - 新增方法：`_sheriff_election()`、`_sheriff_pass_badge()`、`_announce_sheriff_elected()`
  - 修改投票统计：支持1.5倍投票权
  - 修改发言顺序：警长最后发言

- `src/players/player.py` - 系统提示词
  - 游戏基本规则：新增第9条"警长规则"（包含退水机制说明）
  - 游戏常用语：新增"上警"、"退水"、"警徽"、"归票"、"撕警徽"

### 🎯 预期效果
- ✅ 增加游戏策略深度：警长竞选、警徽传递
- ✅ 提升游戏趣味性：1.5倍投票权可以打破僵局
- ✅ 符合标准狼人杀玩法：完整的警长机制
- ✅ AI理解警长规则并做出合理决策

### 📊 代码统计
- 新增代码：~250行（包含退水机制约50行）
- 新增方法：3个
- 修改现有方法：4个

### 🔄 开发过程
- **初始实现**（2025-10-26 上午）：完整警长系统（报名、发言、投票、1.5倍投票权、归票权、警徽传递）
- **规则修正**（2025-10-26 上午）：修复投票规则（所有人上警→警徽流失）
- **退水机制**（2025-10-26 下午）：添加退水阶段（发言后、投票前，候选人可退出竞选）

## [1.5.8] - 2025-10-26

### ✨ 改进

#### 增强LLM调用稳定性 - 超时和重试机制
- **问题**：模型调用偶尔会超时
  - 错误信息："Read timeout on endpoint URL"
  - 原因：boto3客户端默认超时时间较短，某些模型响应慢时会超时

- **改进方案**：
  1. **增加超时时间**：
     - 读取超时从默认值增加到120秒
     - 连接超时设置为10秒
     - 使用boto3的Config配置超时参数

  2. **自动重试机制**：
     - boto3级别：自适应重试模式，最多3次
     - 应用级别：手动重试2次，带指数退避（1秒、2秒、4秒）

  3. **友好的错误提示**：
     - 超时时显示："⚠️ 模型调用超时，正在重试 (1/2)..."
     - 最终失败时提示："建议稍后重试或使用其他模型"

- **代码改动**：
  - 导入 `botocore.config.Config` 和 `time`
  - `__init__()`: 添加Config配置超时和重试
  - `invoke_model()`: 添加手动重试循环和指数退避

### 📝 更新的文件
- `src/utils/llm_client.py` - LLM客户端超时和重试配置

### 🎯 预期效果
- ✅ 减少因超时导致的调用失败
- ✅ 提高游戏流畅性，减少中断
- ✅ 提供更友好的错误提示

## [1.5.7] - 2025-10-26

### 🐛 Bug修复 - 关键规则修正

#### 1. 修复夜晚胜负判定顺序错误
- **问题**：夜晚结束时胜负判定错误
  - **场景**：第4天夜晚，狼人8刀死玩家6（最后一个村民），女巫9毒死玩家8（最后一个狼人）
  - **错误结果**：判定好人胜利
  - **正确结果**：应该判定狼人胜利
  - **原因**：狼刀和女巫毒同时结算，然后一起检查胜负，代码先检查"狼人是否全死"导致误判

- **修复方案**：夜晚行动分步结算
  1. **狼人刀人** → 立即检查胜负 → 如果游戏已结束，停止后续行动
  2. **女巫毒人**（仅在游戏未结束时执行）→ 检查胜负

- **修复逻辑**：
  - 新增 `_process_night_deaths_with_victory_check()` 方法
  - 狼人击杀后立即调用 `_check_game_over()`
  - 如果狼刀导致游戏结束（例如：屠民成功），女巫毒人不再执行
  - 确保狼人胜利条件优先于好人胜利条件（符合行动顺序）

- **影响范围**：
  - ✅ 修复了极端情况下的胜负判定错误
  - ✅ 狼人屠民/屠神成功后立即胜利，女巫无法通过毒死最后一狼来翻盘
  - ✅ 符合狼人杀规则：夜晚行动按顺序结算，先发生的行动先判定结果

#### 2. 修复AI位置迷信问题
- **问题**：AI会基于玩家编号推测身份
  - 错误发言："7号位置敏感，可能是神职"
  - 错误发言："8号容易是预言家"
  - **实际情况**：角色是完全随机分配的（v1.5.1已实现），编号与身份无关

- **修复**：
  - 在系统提示词的"玩家与角色设置"部分添加明确说明
  - 强调：**角色分配是完全随机的**
  - 强调：**玩家编号与身份无关**
  - 禁止："7号位置敏感"、"8号容易是预言家"等基于编号的推理
  - 引导：只能根据发言、行为、投票来推测身份

### 📝 更新的文件
- `src/game/werewolf_game.py` - 夜晚死亡处理逻辑
- `src/players/player.py` - 系统提示词

### 🎯 预期效果
- ✅ 夜晚胜负判定符合规则
- ✅ AI不再基于玩家编号进行错误推理
- ✅ AI推理更符合逻辑，基于实际信息而非位置假设

## [1.5.6] - 2025-10-26

### 🐛 Bug修复

#### 1. 修复遗言自曝问题
- **问题**：AI在遗言中推荐投自己
  - 例如：玩家1被放逐，遗言说"我强烈建议明天推1号"
  - 原因：AI不知道自己是几号玩家，也不知道哪些玩家还活着
- **修复**：
  - 明确告知："你是玩家X号，你已经死亡"
  - 提供存活玩家列表
  - 添加警告："不要推荐投你自己（你已经死了！）"
  - 添加警告："推荐投票目标时，只能从存活玩家中选择"

#### 2. 修复投票提示混淆问题
- **问题**：投票阶段的提示信息造成混淆
  - 显示：`1. 玩家2, 2. 玩家3, ...`（选项编号 vs 玩家编号）
  - 提示说："只需回答玩家编号，如：1"
  - 用户不清楚应该回答"1"（选项编号=玩家2）还是"1"（玩家编号）
- **修复**：
  - 移除选项序号，直接显示玩家编号
  - 改为：`存活的玩家：玩家2, 玩家3, ...`
  - 改为：`你可以投票的玩家编号：2, 3, 4, ...`
  - 提示改为："直接回答玩家编号"
  - 用户输入"2"就是投玩家2，清晰明确

#### 3. 修复发言顺序逻辑错误
- **问题**：AI在发言时不知道发言顺序，导致逻辑错误
  - 例如：5号比1号先发言，但5号说"1号跳了预言家，所以我也跳"
  - 这在逻辑上不可能，因为5号发言时1号还没发言
  - AI会分析还未发言玩家的观点
- **修复**：
  - 在发言prompt中明确告知当前发言位置（第X/Y位）
  - 列出已发言的玩家列表
  - 列出未发言的玩家列表
  - 添加警告："只有在你之前发言的玩家，你才知道他们说了什么"
  - 添加警告："不要分析或提到还未发言玩家的观点"

### 📝 更新的文件
- `src/game/werewolf_game.py` - 遗言环节、投票阶段和发言阶段逻辑
- `src/players/player.py` - HumanPlayer和AIPlayer的决策方法

### 🎯 预期效果
- ✅ AI遗言不会推荐投自己
- ✅ AI遗言只会推荐投存活的玩家
- ✅ 投票时不再混淆选项编号和玩家编号
- ✅ AI发言更符合逻辑，不会提到还未发言玩家的观点
- ✅ AI能正确理解自己在发言序列中的位置
- ✅ 提升游戏的真实性和逻辑一致性

## [1.5.5] - 2025-10-26

### ✨ 新功能 / 游戏常识
- **添加预言家跳身份保护常识**：在系统提示词中添加单跳预言家保护原则
  - **新增常识**：一般如果只有一个预言家起跳，且发言逻辑清晰、报验合理，通常不会被推出去
  - 这是狼人杀游戏中的重要常识，影响投票决策
  - 帮助AI更好地理解村民对单跳预言家的信任倾向
  - 区分单跳和对跳两种情况的处理方式

### 📝 规则说明更新
在"发言分析与防骗指南"中新增第6条：
- ✅ **单跳预言家保护原则**：如果只有一个预言家起跳，且发言逻辑清晰、报验合理，一般不会被推出去
- ⚠️ 这是游戏常识：单跳且发言不错的预言家，通常会被好人阵营相信
- 但要注意：如果出现对跳（两个预言家），则必须通过逻辑分辨真假
- 狼人也要懂这个常识：如果真预言家单跳且发言好，不要强行推他（容易暴露）

### 📝 更新的文件
- `src/players/player.py` - 系统提示词

### 🎯 预期效果
- AI好人阵营会更倾向于相信单跳且发言合理的预言家
- AI好人在投票时不会轻易推出单跳预言家
- AI狼人会理解这个常识，避免过早暴露（强推单跳好预言家会被识破）
- 提升游戏的真实性，更符合实际狼人杀玩法

## [1.5.4] - 2025-10-25

### 🐛 Bug修复
- **强化预言家查验规则**：预言家每晚只能查验一个人
  - **问题**：AI在跳预言家时可能会说"我查了X号是金水，Y号是查杀"，违反了每晚只能查一个人的规则
  - **修复**：在多个地方明确预言家每晚只能查验一名玩家

### 📝 规则强化内容

#### 1. 角色介绍更新
- 预言家：**每天晚上只能查验一名玩家**
- ⚠️ 注意：一晚只能查一个人，不能查验多个人！

#### 2. 游戏基本规则新增第7条
**预言家查验规则**：
- 预言家每晚只能查验**一名**玩家
- ❌ 不能一晚查验多个人
- ❌ 如果你跳预言家，不要报多个查验结果
- ✅ 正确的报验：每晚只报一个查验结果

#### 3. 预言家角色扮演策略
新增"查验规则"部分：
- ⚠️ **每晚只能查验一个人**
- ❌ 不要说"我昨晚查了X号和Y号"
- ✅ 可以累积报验，但每晚只报一个人的结果

#### 4. 信息保密规则强化
- ⚠️ **每晚只能查一个人**，不要违反这个规则！
- ✅ 报查验结果时要明确："我第X晚查验Y号，给出查杀/金水"

### 📝 更新的文件
- `src/players/player.py` - 系统提示词

## [1.5.3] - 2025-10-25

### 🐛 Bug修复
- **防止AI泄露刀口信息**：强化信息保密规则，防止非女巫非狼人玩家在平安夜推测刀口
  - **问题**：AI玩家在平安夜时会说"X号应该是昨晚被刀的"，但他们不可能知道刀口
  - **原因**：AI进行了错误的逻辑推理，推测出了只有女巫和狼人才知道的信息
  - **修复**：在系统提示词中明确禁止这种行为

### 📝 新增规则说明

#### 游戏基本规则第5条扩充：
- 🚫 **重要**：如果你不是女巫或狼人，在平安夜时**绝对不要**推测谁被刀了！你不可能知道刀口！

#### 女巫角色扮演策略：
- ❌ 不要说"X号被刀了但我救了"（暴露刀口信息）
- ❌ 不要说"我知道昨晚X号被刀"（暴露你是女巫）
- ✅ 可以说"昨晚平安夜，可能女巫救人了"（像普通人一样分析）

#### 信息保密规则新增：
**如果你是村民/预言家/猎人（不是女巫或狼人）**：
- 🚫 **平安夜时绝对不要推测刀口**！
- ❌ 不要说"X号应该是昨晚被刀的"
- ❌ 不要说"X号是银水"（你不知道谁被刀了！）
- ✅ 只能说："昨晚平安夜，女巫应该救人了"
- ✅ 或者："平安夜，说明有人被救"
- ⚠️ **只有女巫和狼人知道刀口，你不可能知道！**

### 📝 更新的文件
- `src/players/player.py` - 系统提示词

## [1.5.2] - 2025-10-25

### 🐛 Bug修复 / 规则修正
- **修正女巫获得刀口信息的规则**：女巫不是每晚都自动知道刀口
  - **正确规则**：女巫只有在使用解药时才会被告知当晚谁被狼人击杀
  - **之前的错误实现**：女巫每晚都会被告知刀口信息（即使没有解药）
  - **现在的正确实现**：
    - 女巫有解药时：询问是否用解药，同时告知刀口信息
    - 女巫没有解药时：只询问是否用毒药，不告知刀口信息
    - 女巫选择不用解药时：记录她知道刀口但选择不救
  - 这使得女巫的策略更加复杂和真实

### 📝 规则说明更新
在系统提示词中添加：
- 角色介绍中明确：女巫只有在使用解药时才会被告知刀口
- 游戏基本规则新增第5条：**女巫获得刀口信息的条件**
  - ✅ 女巫有解药时：会被告知刀口，可选择是否救人
  - ❌ 女巫没有解药时：不会被告知刀口，只能选择是否用毒药
  - ⚠️ 女巫用完解药后，就不再知道每晚的刀口了

### 📝 更新的文件
- `src/game/werewolf_game.py` - `_witch_action()` 方法
- `src/players/player.py` - 角色介绍和游戏基本规则

## [1.5.1] - 2025-10-25

### ✨ 改进
- **随机角色分配**：角色现在会随机打乱分配给玩家
  - 之前角色固定：玩家1-3总是狼人，玩家4总是预言家，等等
  - 现在：每局游戏开始时，9个角色会随机打乱后分配给9个玩家
  - 增加游戏的不可预测性和趣味性
  - 狼人队伍不再固定为玩家1、2、3

### 📝 更新的文件
- `src/game/werewolf_game.py` - `_assign_roles()` 方法

## [1.5.0] - 2025-10-25

### ✨ 新功能

#### 1. 狼人互认身份与战术系统
添加狼人互相认识和夜间战术讨论的完整说明：

**游戏基本规则新增**：
- **狼人互相认识**：游戏开始时，所有狼人都知道其他狼人是谁
- 狼人之间是队友关系，要互相配合
- 可以制定各种高级战术

**狼人战术策略**（在"身份伪装与角色扮演策略"中新增）：
- **狼自刀骗解药**：让狼队友刀自己，骗女巫用解药，建立"银水"身份（高风险高回报）
- **狼查杀狼**：悍跳预言家后，"查杀"狼队友，牺牲一狼换取预言家可信度
- **狼打狼**：白天互相怀疑、对抗，迷惑好人
- **深水狼策略**：一狼悍跳吸引火力，另一狼潜伏装好人
- **集火神职**：优先刀掉预言家、女巫等强神

**狼人配合指导**：
- 可以"怀疑"狼队友来增加自己可信度（狼打狼战术）
- 也可以互相"金水"建立信任关系
- 根据战术需要灵活调整
- 不要在白天暴露你们是队友关系

#### 2. 明确狼自刀的规则
- 狼人可以刀狼队友（狼自刀）来骗女巫解药
- 狼自刀也算"杀人"，符合"狼人每晚必须杀人"的规则

### 📝 更新的文件
- `src/players/player.py` - AI系统提示词

### 🎯 预期效果
- AI狼人会理解他们之间是队友关系
- AI狼人会使用高级战术（狼自刀、狼查杀狼等）
- 提升狼人阵营的策略深度和游戏趣味性
- 游戏对抗更加激烈和真实

## [1.4.3] - 2025-10-25

### 🐛 Bug修复
- **修复AI可能说出"狼人空刀"的错误发言**：强化"狼人不能空刀"的规则说明
  - 问题：AI在遇到平安夜时可能会说"狼人可能空刀了"、"狼人怕被查杀所以空刀"等违反规则的话
  - 原因：狼人每晚必须杀人，不能空刀，平安夜只能是女巫救人
  - 修复：在游戏基本规则和信息保密规则中明确禁止这种说法

### 📝 规则强化内容
1. **游戏基本规则第1条扩充**：
   - ❌ 发言时绝对不要说"狼人可能空刀了"、"狼人怕被查杀所以空刀"等违反规则的话
   - ✅ 平安夜的原因只有一个：女巫用了解药救人
   - ✅ 如果昨晚是平安夜，正确的分析是："昨晚平安夜，说明女巫救人了"

2. **信息保密规则（狼人部分）扩充**：
   - ❌ 绝对不要说"狼人可能空刀了"（违反规则，会暴露你不懂游戏）
   - ✅ 遇到平安夜时，可以说："不知道发生了什么，可能女巫救人了"
   - ✅ 或者含糊其辞："昨晚信息量不大"

### 📝 更新的文件
- `src/players/player.py` - AI系统提示词

## [1.4.2] - 2025-10-25

### ✨ 新功能
- **添加"民及民以上身份"话术说明**：在游戏常用语中添加这个常用术语
  - 含义：指村民或神职（预言家、女巫、猎人），即好人阵营的身份
  - 用法：常用于表达"我是好人"（例如："我是民及民以上身份"）
  - 帮助AI使用更专业的狼人杀术语

### 📝 规则说明强化
- **明确猎人开枪规则**：在游戏基本规则中更详细地说明猎人开枪条件
  - ✅ 猎人被狼刀死亡时，可以开枪
  - ✅ 猎人被投票放逐死亡时，可以开枪
  - ❌ 猎人被女巫毒死时，**不能开枪**（重要规则）
  - 代码层面已实现（在 `_process_night_deaths()` 中会调用 `hunter_role.disable_shoot()`）

### 📝 更新的文件
- `src/players/player.py` - AI系统提示词

## [1.4.1] - 2025-10-25

### 🐛 Bug修复
- **修复猎人开枪后未检查游戏结束条件**: 猎人开枪带走玩家后，游戏应立即检查是否满足结束条件
  - 问题场景：猎人带走最后一个神职后，游戏应该结束，但却继续进入夜晚
  - 修复：在 `_last_words()` 中猎人开枪后立即调用 `_check_game_over()`
  - 修复：在 `_day_phase()` 遗言环节后也检查游戏是否结束
  - 现在猎人开枪带走关键玩家后，游戏会立即结束

### 📝 更新的文件
- `src/game/werewolf_game.py` - 遗言环节和白天阶段逻辑

### 🔧 修复细节
- 在 `_last_words()` 方法中，猎人开枪后添加游戏结束检查
- 在 `_day_phase()` 方法中，遗言环节后添加游戏结束检查
- 如果游戏已结束，立即返回，不再继续后续流程

## [1.4.0] - 2025-10-25

### ✨ 新功能

#### 1. 发言顺序优化
玩家死亡后，第二天从死者右边（+1位置）的玩家开始发言：
- 符合标准狼人杀规则
- 自动调整发言顺序，从死者右边开始循环
- 系统会显示提示："（从玩家X的右边开始发言）"
- 如果昨晚是平安夜（无人死亡），保持原有顺序

#### 2. 游戏基本规则说明
在AI系统提示词中添加"游戏基本规则"部分：
- **狼人每晚必须杀人**（不能空刀）
- **女巫不能自救**
- **女巫每晚只能用一瓶药**
- **猎人被毒死不能开枪**
- **发言顺序规则**

这些是狼人杀的基本游戏常识，让AI更好地理解游戏规则。

### 📝 更新的文件
- `src/game/werewolf_game.py` - 发言阶段逻辑
- `src/players/player.py` - AI系统提示词，添加游戏基本规则

### 🔧 实现细节
- 添加 `last_night_first_death` 变量追踪昨晚第一个死亡的玩家
- 在 `_process_night_deaths()` 中记录死亡玩家
- 在 `_speech_phase()` 中根据死者位置重新排序发言顺序
- 使用循环索引确保从死者+1位置开始遍历所有存活玩家
- 在狼人角色介绍中强调"必须"杀人（不能空刀）
- 添加独立的"游戏基本规则"章节列出5条核心规则

## [1.3.0] - 2025-10-25

### ✨ 新功能

#### 1. 增强AI发言分析能力
添加"发言分析与防骗指南"：
- 教导AI不要完全相信任何玩家的发言
- 提供5个维度的发言分析方法：
  1. 验证逻辑一致性
  2. 分析发言动机
  3. 观察行为模式
  4. 交叉验证信息
  5. 保持怀疑态度
- 强调狼人可以假冒任何好身份
- 提醒AI要用逻辑分析，不要盲目相信

#### 2. 身份伪装与角色扮演策略
添加"身份伪装与角色扮演策略"指南：
- **核心提示**：发言前先想"我应该表演成什么身份？"
- **狼人策略**：
  - 选择伪装身份（悍跳预言家、假跳神职、装村民、暗示有身份）
  - 保持人设一致性
  - 混入好人阵营的技巧
- **村民策略**：
  - 战术性伪装（暗示有身份吸引狼刀）
  - 风险平衡（伪装 vs 坦白）
- **各神职策略**：
  - 预言家：早跳/晚跳/对跳的时机选择
  - 女巫：隐藏身份，关键时刻跳女巫
  - 猎人：深藏不露，被推时跳猎人

### 📝 更新的文件
- `src/players/player.py` - AI系统提示词

### 🎯 预期效果
- AI玩家会更加谨慎地分析他人发言
- AI会主动思考应该扮演什么身份
- 狼人AI会有更多样化的伪装策略
- 村民AI会考虑战术性伪装
- 神职AI会选择更合适的跳神时机
- 减少AI被悍跳狼人欺骗的可能性
- 提升游戏的策略性和对抗性
- 使AI的推理过程更接近真实玩家

## [1.2.1] - 2025-10-25

### 🐛 Bug修复
- **修复狼人未做出有效选择的bug**: 狼人每晚必须击杀一名玩家
  - 原因：AI响应格式不正确时，`_parse_player_id`返回None，狼人不杀人
  - 修复：添加重试机制（最多3次），如果仍然失败则随机选择目标
  - 添加明确提示："⚠️ 重要：狼人每晚必须击杀一名玩家"
  - 现在狼人一定会击杀一名玩家，保证游戏流程正常

### 📝 更新的文件
- `src/game/werewolf_game.py` - 狼人行动逻辑

### ⚠️ 重要变更
- **狼人击杀保证机制**: 如果AI无法做出有效选择，系统会随机选择目标
  - 优点：保证游戏规则完整性
  - 缺点：极端情况下可能出现随机选择（但会有明确提示）

## [1.2.0] - 2025-10-25

### 🐛 Bug修复
- **修复预言家查验结果错误**: 玩家名称与实际角色不匹配导致查验结果错误
  - 原因：角色随机分配导致"AI-狼人1"可能不是狼人
  - 修复：改为固定角色分配，确保名称与角色一致
  - 现在玩家1-3永远是狼人，玩家4是预言家，依此类推

- **修复女巫可以自救的bug**: 女巫不应该能救自己
  - 原因：条件判断逻辑错误 (`not is_self or not witch_role.cannot_save_self`)
  - 修复：正确的逻辑 (`is_self and witch_role.cannot_save_self`)
  - 现在女巫被击杀时会显示"女巫被击杀，但不能自救"

- **修复女巫同一晚使用两瓶药的bug**: 女巫每晚最多只能使用一瓶药
  - 原因：没有检查是否已使用解药就继续询问毒药
  - 修复：添加 `used_potion_tonight` 标记，使用解药后不再询问毒药
  - 现在女巫使用解药后会显示"女巫今晚已使用解药，不能再使用毒药"

- **修复女巫解药不生效的bug**: 女巫使用解药后玩家仍然死亡
  - 原因：函数内部修改`wolf_kill_target = None`不影响外部变量
  - 修复：修改函数返回值，返回修改后的`wolf_kill_target`和`poison_target`
  - 现在女巫使用解药后，被救的玩家会正确存活

- **修复女巫记忆保存bug**: 救人后记忆保存的玩家ID错误
  - 原因：`wolf_kill_target`被设为None后再保存记忆
  - 修复：先保存被救玩家信息，再清空`wolf_kill_target`

### 📝 更新的文件
- `src/game/werewolf_game.py` - 角色分配逻辑、女巫行动逻辑
- 新增 `BUGFIX_v1.2.0.md` - 详细的bug修复说明

### ⚠️ 重要变更
- **角色分配不再随机**: 为确保玩家名称与角色一致，角色位置固定
  - 优点：便于调试和观察
  - 缺点：缺少随机性
  - 建议：后续可添加配置选项支持随机模式

## [1.1.1] - 2025-10-25

### ✨ 改进
- **更新AI系统提示词**: 使用专业狼人杀术语和规则
  - 添加完整的游戏规则体系
  - 添加10个专业术语（查杀、金水、银水、悍跳等）
  - 增强策略指导
  - 修正女巫规则描述（明确不能自救）

### 📝 更新的文件
- `src/players/player.py` - AI玩家系统提示词
- 新增 `SYSTEM_PROMPT_UPDATE.md` - 系统提示词更新说明

## [1.1.0] - 2025-10-25

### 修复
- **移除不可用的模型**: 移除了在当前AWS区域不可用的模型
  - 移除 `us.deepseek.v3-v1:0` (ValidationException)
  - 移除 `us.deepseek.r1-v1:0` (ValidationException)
  - 移除 `us.anthropic.claude-3-5-sonnet-20241022-v2:0` (已被新版本替代)

### 变更
- **更新AI模型分配**: 所有角色现在仅使用可用的Claude系列模型
  - 狼人1: Claude Opus 4 (20250514)
  - 狼人2: Claude Sonnet 4.5 (20250929)
  - 狼人3: Claude 3.7 Sonnet (20250219)
  - 预言家: Claude Opus 4.1 (20250805)
  - 女巫: Claude Sonnet 4 (20250514)
  - 猎人: Claude Sonnet 4.5 (20250929) ← 更新
  - 村民1: Claude Haiku 4.5 (20251001) ← 更新
  - 村民2: Claude 3.7 Sonnet (20250219) ← 更新
  - 村民3: Claude Haiku 4.5 (20251001)

### 更新的文件
- `src/utils/llm_client.py` - 更新可用模型列表和默认分配
- `config_example.py` - 更新配置示例
- `test_setup.py` - 更新测试模型列表
- `README.md` - 更新模型分配表格
- 新增 `CHANGELOG.md` - 记录版本变更

### 影响
- ✅ 游戏现在只使用经过验证的可用模型
- ✅ 不再出现模型调用错误
- ✅ 所有AI玩家都能正常工作
- ℹ️ 性能可能略有提升（全部使用Claude系列高质量模型）
- ⚠️ 成本可能略有增加（Haiku替代了DeepSeek）

## [1.0.0] - 2025-10-25

### 新增
- 🎮 完整的9人狼人杀游戏实现
- 🤖 支持9种不同AI模型
- 👥 支持人类和AI混合对战
- 📚 完整的游戏文档
- 🔧 环境测试工具
- 🚀 快速启动脚本

### 角色实现
- 狼人（3名）- 夜晚击杀
- 预言家 - 查验身份
- 女巫 - 解药和毒药
- 猎人 - 死亡开枪
- 村民（3名）- 投票推理

### 游戏特性
- 完整的夜晚/白天循环
- 遗言系统
- 投票放逐
- 胜负判定
- AI记忆系统
