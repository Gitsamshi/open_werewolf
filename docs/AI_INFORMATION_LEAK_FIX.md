# AI信息泄露问题修复 - v1.2.1

## 问题描述

### 发现时间
2025-10-25

### 问题现象

**场景**：
```
狼人击杀玩家4
女巫使用解药救了玩家4
天亮后是平安夜

玩家1（狼人）发言：
  "昨晚平安夜，说明女巫用了解药救人。4号大概率是银水。"
  
玩家2（狼人）发言：
  "女巫昨晚如果救了4号，今天应该是平安夜才对。"
```

**问题**：
- 玩家1和玩家2都是狼人
- 他们知道昨晚杀了玩家4（狼人的夜间信息）
- 但他们在发言中透露了这个信息！
- 这会让其他玩家怀疑："你怎么知道4号被杀了？"

## 根本原因

### 1. 狼人记忆包含刀口信息（正确）

```python
# src/game/werewolf_game.py 第198行
for wolf in werewolves:
    if isinstance(wolf, AIPlayer):
        wolf.add_memory(f"第{self.day_count}晚：狼人击杀了玩家{target.player_id}")
```

这是**正确的**，狼人应该知道自己的刀口。

### 2. AI没有遵守信息保密原则（问题所在）

AI在发言时直接使用了这个信息，说出了类似：
- "4号大概率是银水"（暴露知道4号被杀）
- "女巫如果救了4号"（暴露知道4号被杀）

真实的狼人玩家会**隐藏**这个信息，假装不知道刀口。

## 修复方案

### ✅ 已实施：增强系统提示词

在 `src/players/player.py` 中添加了详细的**信息保密规则**：

```python
### 信息保密规则 ###
⚠️ 非常重要：不要泄露只有你知道的信息！

如果你是狼人：
- ❌ 不要透露你知道昨晚的刀口（击杀目标）
- ❌ 不要说"我们狼人昨晚杀了谁"
- ❌ 不要说"昨晚是平安夜说明女巫救人了"（这暴露你知道刀口）
- ✅ 可以假装不知道刀口，像好人一样分析
- ✅ 例如："昨晚平安夜，可能是狼人没杀人，也可能是女巫救人"

如果你是预言家：
- ❌ 不要一开始就报出所有查验信息
- ✅ 选择合适的时机跳预言家
- ✅ 报查验结果时要明确（"我查验X号，给出查杀/金水"）

如果你是女巫：
- ❌ 不要透露你用了解药或毒药
- ❌ 不要说"我昨晚救了谁"（除非你要跳女巫）
- ✅ 保密用药信息，直到必要时才暴露

如果你是猎人：
- ✅ 一般不要主动跳猎人
- ✅ 被推出局时可以跳猎人自保

记住：只说你这个角色应该知道的信息！
```

## 正确的发言示例

### 场景：狼人知道刀了4号，但是平安夜

#### ❌ 错误发言（泄露信息）
```
玩家1（狼人）：
"昨晚平安夜，说明女巫用了解药救人。4号大概率是银水。"
→ 问题：怎么知道4号被杀了？
```

#### ✅ 正确发言（隐藏信息）
```
玩家1（狼人）：
"昨晚是平安夜，可能有两种情况：
1. 狼人空刀（没杀人）
2. 女巫用了解药
建议预言家尽快跳出来报查验信息。"
→ 正确：没有透露知道刀口
```

### 场景：预言家查验到狼人

#### ❌ 错误发言（过早暴露）
```
玩家4（预言家）：
"我是预言家，昨晚查验1号是狼人，查验2号也是狼人，查验3号还是狼人。"
→ 问题：一晚只能查一个人！
```

#### ✅ 正确发言（合理报验）
```
玩家4（预言家）：
"我起跳预言家，昨晚查验1号玩家，给出查杀。
建议今天投1号。"
→ 正确：只报当前的查验结果
```

### 场景：女巫用了解药

#### ❌ 错误发言（泄露用药）
```
玩家5（女巫）：
"昨晚我用解药救了4号。"
→ 问题：暴露女巫身份，可能被狼人针对
```

#### ✅ 正确发言（保密）
```
玩家5（女巫）：
"昨晚是平安夜，建议预言家跳出来。
我觉得1号发言有问题。"
→ 正确：不透露用药信息
```

## 信息对称表

| 角色 | 知道的夜间信息 | 能否公开 |
|------|--------------|---------|
| 狼人 | 自己的刀口 | ❌ 不能 |
| 预言家 | 查验结果 | ✅ 可以（选择时机）|
| 女巫 | 刀口、是否用药 | ❌ 一般不能 |
| 猎人 | 无 | - |
| 村民 | 无 | - |

**白天所有人都知道的信息**：
- 昨晚是否有人死亡
- 死了几个人
- 死者的遗言

**只有特定角色知道的信息**：
- 狼人：刀口是谁
- 预言家：查验结果
- 女巫：刀口是谁、是否用药

## 测试场景

### 测试1：狼人不泄露刀口
```
场景：
  狼人刀了4号
  女巫救了4号
  平安夜

狼人发言：
  ✅ "昨晚平安夜，不知道是空刀还是女巫救人"
  ❌ "4号应该是银水"
```

### 测试2：预言家报验
```
场景：
  预言家查验1号是狼人

预言家发言：
  ✅ "我是预言家，查验1号给出查杀"
  ❌ "我是预言家，我知道1号2号3号都是狼人"
```

### 测试3：女巫保密
```
场景：
  女巫用了解药救人

女巫发言：
  ✅ "建议预言家跳出来"
  ❌ "我昨晚用解药救了人"
```

## 影响

### 修复前
- ❌ 狼人会说"4号是银水"（泄露刀口）
- ❌ 好人容易识破狼人
- ❌ 游戏平衡性差

### 修复后
- ✅ 狼人会隐藏刀口信息
- ✅ 更符合真实玩家的行为
- ✅ 游戏更有挑战性
- ✅ AI发言更加真实

## 注意事项

### LLM的限制

即使添加了详细的提示词，LLM仍然可能：
1. 偶尔泄露信息（概率性问题）
2. 没有完全理解"信息对称"概念
3. 逻辑推理过于明显

这是LLM玩狼人杀的固有挑战，需要：
- 更精确的提示词工程
- 可能需要多轮对话优化
- 或者使用更强的模型（如GPT-4）

### 建议

1. **测试新游戏**：重新运行游戏，观察AI是否还会泄露信息
2. **调整提示词**：如果仍有问题，继续优化提示词
3. **记录案例**：收集AI泄露信息的案例，针对性改进

## 总结

✅ 已添加详细的信息保密规则到系统提示词
✅ 明确告诉AI各角色能说什么、不能说什么
✅ 提供正确和错误的发言示例

下次游戏时，AI应该会更加谨慎，不会轻易泄露只有自己知道的信息。

如果仍有问题，可能需要：
- 进一步强化提示词
- 使用更强的LLM模型
- 或添加后处理逻辑过滤敏感信息
